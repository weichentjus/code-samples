with a as (SELECT
cce.source_system_id,
cce.encntr_id,
cce.person_id,
cce.accession_nbr,
cce.valid_from_dt_tm,
cce.result_val,
ccve.display
FROM access_clindsa.cerner_clinical_event cce 

LEFT JOIN access_clindsa.cerner_code_value ccve
ON cce.source_system_id = ccve.source_system_id 
AND cce.event_cd = ccve.code_value 

WHERE ccve.display LIKE 'Unit%'
AND cce.source_system_id = 30000000
AND cce.result_val in ('W031'),


-----AND to_date(cce.valid_from_dt_tm) BETWEEN '2019-01-01' AND '2025-02-28'),




b as (SELECT 
DISTINCT 
ce.source_system_id,
ce.encntr_id,
ce.person_id,
---cea.alias AS fin,
coc.primary_mnemonic,
--ccve.display,
cce.result_val

FROM access_clindsa.cerner_encounter ce
LEFT JOIN access_clindsa.cerner_encntr_alias cea 
ON ce.source_system_id = cea.source_system_id 
AND ce.encntr_id = cea.encntr_id 

LEFT JOIN access_clindsa.cerner_orders co
ON ce.source_system_id = co.source_system_id 
AND ce.encntr_id = co.encntr_id 
AND ce.person_id = co.person_id 

LEFT JOIN access_clindsa.cerner_order_catalog coc 
ON co.source_system_id = coc.source_system_id 
AND co.catalog_cd = coc.catalog_cd 
AND co.catalog_type_cd = coc.catalog_type_cd 

LEFT JOIN access_clindsa.cerner_clinical_event cce 
ON ce.source_system_id = cce.source_system_id 
AND ce.encntr_id = cce.encntr_id 
AND ce.person_id = cce.person_id 

/*LEFT JOIN access_clindsa.cerner_code_value ccve
ON cce.source_system_id = ccve.source_system_id 
AND cce.event_cd = ccve.code_value
AND ccve.code_set = 72*/

WHERE ce.source_system_id = 30000000
AND ce.active_ind = 1
AND cea.active_ind = 1
AND cea.end_effective_dt_tm > now()
AND cea.encntr_alias_type_cd = 1077
AND co.order_status_cd = 2543
AND coc.primary_mnemonic IN ('Lab Order ABORH and Antibody Screen','Type and Screen')
--'ABO, Rh'
AND cce.event_cd = 3277179)
--AND ccve.display IN ('ABO, Rh')



select a.result_val, b.result_val
from a
left join b
on a.source_system_id=b.source_system_id
and a.encntr_id=b.encntr_id
and a.person_id=b.person_id

---left join c
---on a.source_system_id=c.source_system_id
---and a.encntr_id=c.encntr_id
---and a.person_id=c.person_id
